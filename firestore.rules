rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ヘルパー関数
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isGoogleUser() {
      return isSignedIn() && request.auth.token.firebase.sign_in_provider == 'google.com';
    }
    
    // 文字列またはリストから単一のIDを安全に取得
    function getID(val) {
      return val is list ? val[0] : val;
    }

    // トークンに紐づくロールを取得
    function getStaffRole(productionId, token) {
      let staffTokens = get(/databases/$(database)/documents/productions/$(getID(productionId))).data.staffTokens;
      let tokenData = staffTokens != null && token in staffTokens ? staffTokens[token] : null;
      return tokenData is string ? tokenData : (tokenData != null ? tokenData.role : null);
    }

    // 匿名認証UIDが特定の公演のスタッフセッションを持っているか確認
    function isAuthorizedStaff(productionId) {
      let sessionPath = /databases/$(database)/documents/staffSessions/$(request.auth.uid);
      let sessionData = exists(sessionPath) ? get(sessionPath).data : null;
      let targetId = getID(productionId);
      return sessionData != null && 
             sessionData.productionId == targetId && 
             (sessionData.expiresAt == null || sessionData.expiresAt > request.time);
    }

    // セッションからスタッフのトークンを取得
    function getStaffTokenFromSession() {
      let sessionPath = /databases/$(database)/documents/staffSessions/$(request.auth.uid);
      return exists(sessionPath) ? get(sessionPath).data.token : null;
    }

    // ロールごとの更新許可フィールド定義
    // monitor ロールは読み取り専用のため空配列を返す → update 不可
    function getAllowedFields(role) {
      return role == 'reception' ? 
        ['checkedInTickets', 'checkinStatus', 'checkedIn', 'remarks', 'staffNote', 'status', 'paymentStatus', 'paidAmount', 'updatedAt'] :
        [];
    }

    // 公演（Production）
    match /productions/{productionId} {
      // 予約フォームまたはトークン保持者は get 可能
      allow get: if true; 
      allow list: if isSignedIn();
      allow create: if isGoogleUser();
      allow update, delete: if isOwner(resource.data.userId);
    }

    // 予約（Reservation）
    match /reservations/{reservationId} {
      allow create: if true;
      
      // 個別取得
      allow get: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        isAuthorizedStaff(resource.data.productionId) ||
        get(/databases/$(database)/documents/productions/$(resource.data.productionId)).data.userId == request.auth.uid
      );

      // 一覧取得
      allow list: if isSignedIn() && (
        // 1. プロダクション単位のアクセス（主催者 or スタッフ）
        // 型エラーの起きやすい request.query ではなく resource.data を基準に判定
        (resource.data.productionId != null && (
          get(/databases/$(database)/documents/productions/$(resource.data.productionId)).data.userId == request.auth.uid ||
          isAuthorizedStaff(resource.data.productionId)
        )) ||
        // 2. ユーザー指定のクエリ（一般客 or 主催者自身の予約）
        (request.query.userId != null && request.query.userId == request.auth.uid) ||
        // 3. 全ドキュメントの所有権チェック
        (resource.data.userId == request.auth.uid)
      );
      
      allow update: if (isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        (
          isAuthorizedStaff(resource.data.productionId) &&
          request.writeFields.hasOnly(getAllowedFields(getStaffRole(resource.data.productionId, getStaffTokenFromSession())).concat(['_staffToken', 'updatedAt']))
        )
      ));

      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // スタッフセッション (StaffSessions)
    match /staffSessions/{uid} {
      allow read: if isSignedIn() && request.auth.uid == uid;
      
      // クライアント側でセッションを作成・更新することを許可 (正しいパスコードハッシュが必要)
      allow create, update: if isSignedIn() && request.auth.uid == uid && 
        get(/databases/$(database)/documents/productions/$(request.resource.data.productionId)).data.staffTokens[request.resource.data.token].passcodeHashed == request.resource.data.passcodeHashed;
      
      allow delete: if isSignedIn() && request.auth.uid == uid;
    }

    // ユーザープロファイル
    match /users/{userId} {
      allow read, write: if isOwner(userId);
    }

    // 劇団 (Troupe)
    match /troupes/{troupeId} {
      allow read: if isSignedIn();
      allow create: if isGoogleUser();
      allow update, delete: if isOwner(resource.data.ownerId);
    }

    // 所属 (Membership)
    match /memberships/{membershipId} {
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid || 
        get(/databases/$(database)/documents/troupes/$(resource.data.troupeId)).data.ownerId == request.auth.uid
      );
      allow create: if isGoogleUser();
      allow update, delete: if isOwner(resource.data.userId);
    }

    // 公演回 (Performance)
    match /performances/{performanceId} {
      allow read: if true;
      allow create: if isGoogleUser();
      allow update, delete: if isOwner(resource.data.userId);
    }

    // チェックインログ (CheckinLogs)
    match /checkinLogs/{logId} {
      allow read, write: if isSignedIn();
    }

    // ── アンケート関連 ──

    // 将来の「限定共有URL」対応を見据えた閲覧権限判定
    // 現時点では isOwner() と同義。共有機能実装時にここだけ書き換える。
    function canViewSurvey(ownerId) {
      return isOwner(ownerId);
    }

    // アンケートテンプレート (SurveyTemplates)
    match /surveyTemplates/{templateId} {
      // 公開中(active)のテンプレートは匿名読み取りを許可（お客様回答フォーム用）
      // それ以外はオーナーのみ閲覧可
      allow read: if resource.data.status == 'active'
                  || (isSignedIn() && canViewSurvey(resource.data.userId));
      allow create: if isGoogleUser();
      allow update, delete: if isOwner(resource.data.userId);
    }

    // アンケート回答（生データ）(SurveyResponses)
    match /surveyResponses/{responseId} {
      allow create: if true;  // 匿名回答を許可
      allow read, list: if isSignedIn() && canViewSurvey(
        get(/databases/$(database)/documents/surveyTemplates/$(resource.data.surveyTemplateId)).data.userId
      );
      allow update, delete: if false;  // 回答の改竄・削除は一切禁止
    }

    // レイアウトデータ（AI解析用座標JSON）(SurveyLayouts)
    // is_final: false → 下書き保存、is_final: true → PDF確定済み
    match /surveyLayouts/{layoutId} {
      allow read, list: if isSignedIn() && isOwner(resource.data.user_id);
      allow create: if isGoogleUser();
      allow update, delete: if isSignedIn() && isOwner(resource.data.user_id);

      // バージョン管理サブコレクション（追記のみ・不変）
      match /versions/{versionId} {
        allow read, list: if isSignedIn() && isOwner(resource.data.user_id);
        allow create: if isGoogleUser();
        allow update, delete: if false; // バージョンは一度作ったら変更禁止
      }
    }

    // 編集ドラフト（JSON不要・編集状態のみ保存・常に上書き）
    match /surveyLayoutDrafts/{templateId} {
      allow read, list: if isSignedIn() && isOwner(resource.data.user_id);
      allow create: if isGoogleUser();
      allow update, delete: if isSignedIn() && isOwner(resource.data.user_id);
    }
  }
}
